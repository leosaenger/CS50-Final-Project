{% extends "layout.html" %}

{% block title %}
    Run Anywhere
{% endblock %}

{% block main %}
    <div class="container-fluid">
      <div class="row">
        <div class="col-6">
          <div id="map-container">
            <div id="map"></div>
          </div>
          <div id='geocoder' class='geocoder'></div>
          <nav id='listing-group' class='listing-group'>
            <input type='checkbox' id='showRoutes' checked='checked'>
            <label for='showRoutes'>Show nearby routes</label>
            <input type='checkbox' id='boxZoom' checked='checked'>
            <label for='boxZoom'>Box zoom</label>
            <input type='checkbox' id='dragRotate' checked='checked'>
            <label for='dragRotate'>Drag rotate</label>
            <input type='checkbox' id='dragPan' checked='checked'>
            <label for='dragPan'>Drag pan</label>
            <input type='checkbox' id='keyboard' checked='checked'>
            <label for='keyboard'>Keyboard</label>
            <input type='checkbox' id='doubleClickZoom' checked='checked'>
            <label for='doubleClickZoom'>Double click zoom</label>
            <input type='checkbox' id='touchZoomRotate' checked='checked'>
            <label for='touchZoomRotate'>Touch zoom rotate</label>
          </nav>
        </div>
        <div class="col-md-auto">
          <table id="routes_list" class="display" width="100%">
            <thead>
              <tr>
                <th>Name</th>
                <th>Average Grade</th>
                <th>Elevation Difference</th>
                <th>Distance</th>
                <th>Select Route</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>

    <script>
        // Defines the root of our function, for flexibility
        // See: http://flask.pocoo.org/docs/1.0/patterns/jquery/
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
        // Renders a mapbox map
        mapboxgl.accessToken = 'pk.eyJ1IjoibGVvc2FlbmdlciIsImEiOiJjam9wOGVsczkwa2ZzM3FsMWQxdHc2NHZzIn0.2yb_-4yL8nlzA1eEFjDRKw';
        const map = new mapboxgl.Map({
            container: 'map', // References container
            style: 'mapbox://styles/leosaenger/cjop8gvrp2yz42ro2xlwzyhhn', // Custom styling
            center: [-71.116404, 42.374346], // Centered on Cambridge by default
            zoom: 13.6 // Zoom
        });
        // See user's location
        map.addControl(new mapboxgl.GeolocateControl({
          positionOptions: {
            enableHighAccuracy: true
          },
          trackUserLocation: true
        }));
        let routeNum = 0;
        let layers = [];

        function drawRoute(point1, point2)
        {
          let eachLayer = [];
          for(let i = 0; i < layers.length; i++)
          {
            console.log(layers[i]);
            for(let j = 0; j < layers[i].length; j++)
            {
              map.setLayoutProperty(layers[i][j], 'visibility', 'none');
            }
          }
          $.getJSON($SCRIPT_ROOT + '/get_routes', {
            lat: point1,
            long: point2,
          }, function(data) {
            var routes_list = data;
            // Initialize a table with the data, anonymous function
            (function(){

              // Creates table
              var table = $('#routes_list').DataTable({
                processing: true,
                "data": data.data,
                "columns": [
                  { "data": "name" },
                  { "data": "avg_grade" },
                  { "data": "elev_difference" },
                  { "data": "distance" },
                  {
                      "targets": -1,
                      "data": null,
                      "defaultContent": "<button type='button' class='btn btn-secondary'>Select Route</button>"
                  }
                ],
              });

              // Adding a button
              $('#routes_list tbody').on( 'click', 'button', function () {
                  var data = table.row( $(this).parents('tr') ).data();
                  alert(data.name);
                  console.log(data.points);
              });
            })();
            // Parse through the data
            for (var i = 0; i < routes_list.data.length; i++) {
              var name = routes_list.data[i].name;
              var avg_grade = routes_list.data[i].avg_grade;
              var elev_difference = routes_list.data[i].elev_difference;
              var distance = routes_list.data[i].distance;
              var coords = []
              for (var j = 0; j < routes_list.data.length; j++) {
                coords.push(routes_list.data[j].points);
              }
              // Keep track of which route we're on
              let id = "route" + routeNum;
              let marker1 = "custom-marker" + routeNum;
              let id2 = "markers" + routeNum;
              // Keep track of start lat and long, for connecting routes
              let lat1 = coords[i][0][0];
              let long1 = coords[i][0][1];
              routeNum++;
              // Dict of colors to iterate through
              var colors = [
                  '#2C3E50',
                  '#E74C3C',
                  '#ECF0F1',
                  '#3498DB',
                  '#2980B9',
                  '#2C3E50',
                  '#E74C3C',
                  '#ECF0F1',
                  '#3498DB',
                  '#2980B9'
              ];
              // Map each coordinate set
              map.addLayer({
                  "id": id,
                  "type": "line",
                  "source": {
                      "type": "geojson",
                      "data": {
                          "type": "Feature",
                          "properties": {},
                          "geometry": {
                              "type": "LineString",
                              "coordinates": coords[i]
                          }
                      }
                  },
                  "layout": {
                      "line-join": "round",
                      "line-cap": "round"
                  },
                  "paint": {
                      "line-color": colors[i],
                      "line-width": 4
                  }
              });
              eachLayer.push(id);
              // // Define a marker at each route head
              // var geojson = {
              //   type: 'FeatureCollection',
              //   features: [{
              //     type: 'Feature',
              //     geometry: {
              //       type: 'Point',
              //       coordinates: [lat1, long1],
              //     }
              //   }]
              // };
              // // Define the data within each marker
              // geojson.features.forEach(function(marker) {
              //   // create a HTML element for each feature
              //   var el = document.createElement('div');
              //   el.className = 'marker';
              //
              //   // make a marker for each feature and add to the map
              //   let marker1 = new mapboxgl.Marker(el)
              //   marker1.setLngLat(marker.geometry.coordinates)
              //   marker1.setOffset([0, -16])
              //   var meme = marker1.getOffset()
              //   marker1.addTo(map);
              //   console.log(meme);
              //     // add marker to map
              //   new mapboxgl.Marker(el)
              //       .setLngLat(marker.geometry.coordinates)
              //       .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
              //       .setHTML('<h5>' + name + '</h5><p>' +
              //         'Elevation Difference: ' + elev_difference + '</p><p>' +
              //         'Distance: ' + distance + '</p><p>'+
              //         'Average Grade: ' + avg_grade + '</p>'))
              //       .addTo(map);
              // });
              // Set the opacity a bit lower
              map.setPaintProperty(id, 'line-opacity', 70 / 100);
              // If we have more than one route, connect them
              if (i != 0) {
                // Define needed data for connecting
                let len = coords[i].length - 1;
                let lenpast = coords[i-1].length - 1;
                let endlat = coords[i][len][0];
                let endlong = coords[i][len][1];
                let startlat = coords[i-1][lenpast][0];
                let startlong = coords[i-1][lenpast][1];
                let routename = 'routeconnect' + routeNum;
                // Get the connector
                var directionsRequest = 'https://api.mapbox.com/directions/v5/mapbox/walking/' + endlat + ',' + endlong + ';' + startlat + ',' + startlong + '?geometries=geojson&access_token=' + mapboxgl.accessToken;
                // AJAX the route data from mapbox
                $.ajax({
                  method: 'GET',
                  url: directionsRequest,
                }).done(function(data) {
                  // Display the route between each
                  var route = data.routes[0].geometry;
                  map.addLayer({
                    id: routename,
                    type: 'line',
                    source: {
                      type: 'geojson',
                      data: {
                        type: 'Feature',
                        geometry: route
                      }
                    },
                    paint: {
                      'line-width': 2
                    }
                  });
                  eachLayer.push(routename);
                });
              }

              let iconid = "places" + routeNum;

              map.addLayer({
                "id": iconid,
                "type": "symbol",
                "source": {
                    "type": "geojson",
                    "data": {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "properties": {
                                "description": '<h5>' + name + '</h5><p>' +
                                        'Elevation Difference: ' + elev_difference + '</p><p>' +
                                        'Distance: ' + distance + '</p><p>'+
                                        'Average Grade: ' + avg_grade + '</p>',
                                "icon": "marker"
                            },
                            "geometry": {
                                "type": "Point",
                                "coordinates": [lat1, long1]
                            }
                        }]
                    }
                },
                "layout": {
                    "icon-image": "{icon}-15",
                    "icon-allow-overlap": true
                }
              });
              eachLayer.push(iconid);
            map.on('click', iconid, function (e) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var description = e.features[0].properties.description;

                // Ensure that if the map is zoomed out such that multiple
                // copies of the feature are visible, the popup appears
                // over the copy being pointed to.
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);
            });

            // Change the cursor to a pointer when the mouse is over the places layer.
            map.on('mouseenter', iconid, function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            // Change it back to a pointer when it leaves.
            map.on('mouseleave', iconid, function () {
                map.getCanvas().style.cursor = '';
            });
            }
          });
          layers.push(eachLayer);
        }

        var geocoder = new MapboxGeocoder({
          accessToken: mapboxgl.accessToken
        });
        map.addControl(geocoder);
        // After the map style has loaded on the page, add a source layer and default
        // styling for a single point.
        map.on('load', function() {
            map.addSource('single-point', {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": []
                }
            });
            map.addLayer({
                "id": "point",
                "source": "single-point",
                "type": "circle",
                "paint": {
                    "circle-radius": 10,
                    "circle-color": "#007cbf"
                }
            });
            // Listen for the `result` event from the MapboxGeocoder that is triggered when a user
            // makes a selection and add a symbol that matches the result.
            let lastGeocode = "";
            geocoder.on('result', function(ev) {
              if(ev.result.center.toString() !== lastGeocode){
                map.getSource('single-point').setData(ev.result.geometry);
                let position = ev.result.geometry.coordinates;
                drawRoute(position[1], position[0]);
              }

              lastGeocode = ev.result.center.toString();
            });
        });
        // Gets the user's current location, as per: https://developers.google.com/web/fundamentals/native-hardware/user-location/
        // Humanizes Error messages
        function humanizeGeolocationErrorMsg(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    console.log("User denied the request for Geolocation.");
                case error.POSITION_UNAVAILABLE:
                    console.log("Location information is unavailable.");
                case error.TIMEOUT:
                    console.log("The request to get user location timed out.");
                case error.UNKNOWN_ERROR:
                    console.log("An unknown error occurred.");
            }
        }

        window.onload = function displaylines() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Once we have the user's position
                    function(position) {
                        // Pass to Flask route using AJAX
                        drawRoute(position.coords.latitude, position.coords.longitude);
                    }, function(error) {
                        handleNotifications(map, map.getCenter(), humanizeGeolocationErrorMsg(error));
                    }
                )
            } else {
                handleNotifications(map, map.getCenter(), "Your browser doesn't support html5 geolocation");
            }
        }
        // Draws routes with two given points


        document.getElementById('listing-group').addEventListener('change', function(e) {
            var handler = e.target.id;
            if (e.target.checked && handler === 'showRoutes') {
                console.log("huh");
            }
        });


    </script>

{% endblock %}
